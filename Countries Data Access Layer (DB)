using System;
using System.Data;
using System.Data.SqlClient;

namespace CountriesDataAccessLayer
{
    public class clsCountryDataAccess
    {
        public static string connectionString = "Server = . ; Database = ContactsDB ; User Id = sa ; Password = sa123456"; // Replace with actual connection string

        public static bool GetCountryInfoByID(int ID, ref string CountryName, ref string Code, ref string PhoneCode)
        {
            {
                SqlConnection connection = new SqlConnection(connectionString);
                string query = "select * from Countries where CountryID = @CountryID";

                SqlCommand command = new SqlCommand(query, connection);
                command.Parameters.AddWithValue("@CountryID", ID);

                bool isFound = false;

                try
                {
                    connection.Open();
                    SqlDataReader reader = command.ExecuteReader();

                    if (reader.Read())
                    {
                        isFound = true;
                        CountryName = (string)reader["CountryName"];
                        Code = reader["Code"] != DBNull.Value ? reader["Code"].ToString() : "";
                        PhoneCode = reader["PhoneCode"] != DBNull.Value ? reader["PhoneCode"].ToString() : "";
                    }

                    reader.Close();
                }

                catch (Exception)
                {
                    //Console.WriteLine(ex.Message);
                    isFound = false;
                }

                finally
                {
                    connection.Close();
                }

                return isFound;
            }
        }

        public static bool GetCountryInfoByName(ref int ID, string CountryName, ref string Code, ref string PhoneCode)
        {
            {
                SqlConnection connection = new SqlConnection(connectionString);
                string query = "select * from Countries where CountryName = @CountryName";

                SqlCommand command = new SqlCommand(query, connection);
                command.Parameters.AddWithValue("@CountryName", CountryName);

                bool isFound = false;

                try
                {
                    connection.Open();
                    SqlDataReader reader = command.ExecuteReader();

                    if (reader.Read())
                    {
                        isFound = true;
                        ID = (int)reader["CountryID"];
                        Code = reader["Code"] != DBNull.Value ? reader["Code"].ToString() : "";
                        PhoneCode = reader["PhoneCode"] != DBNull.Value ? reader["PhoneCode"].ToString() : "";
                    }

                    reader.Close();
                }

                catch (Exception)
                {
                    //Console.WriteLine(ex.Message);
                    isFound = false;
                }

                finally
                {
                    connection.Close();
                }

                return isFound;
            }
        }

        public static int AddNewCountry(string CountryName, string Code, string PhoneCode)
        {
            SqlConnection connection = new SqlConnection(connectionString);
            string query = @"insert into Countries (CountryName, Code, PhoneCode)
                            values (@CountryName, @Code, @PhoneCode);
                            select SCOPE_IDENTITY();";

            SqlCommand command = new SqlCommand(query, connection);
            command.Parameters.AddWithValue("@CountryName", CountryName);
            command.Parameters.AddWithValue("@Code", Code);
            command.Parameters.AddWithValue("@PhoneCode", PhoneCode);

            int CountryID = -1;

            try
            {
                connection.Open(); // never forget to open the connection, then close it at the end
                object result = command.ExecuteScalar();

                if (result != null && int.TryParse(result.ToString(), out int insertedID))
                {
                    CountryID = insertedID;
                }
            }

            catch (Exception)
            {

            }

            finally
            {
                connection.Close();
            }

            return CountryID;
        }

        public static bool UpdateCountry(int ID, string CountryName, string Code, string PhoneCode)
        {
            SqlConnection connection = new SqlConnection(connectionString);
            string query = @"Update  Countries  
                            set CountryName = @CountryName,
                                Code = @Code,
                                PhoneCode = @PhoneCode
                                where CountryID = @CountryID";

            SqlCommand command = new SqlCommand(query, connection);
            command.Parameters.AddWithValue("@CountryID", ID);
            command.Parameters.AddWithValue("@CountryName", CountryName);
            command.Parameters.AddWithValue("@Code", Code);
            command.Parameters.AddWithValue("@PhoneCode", PhoneCode);

            int rowsAffected = 0;

            try
            {
                connection.Open();

                rowsAffected = command.ExecuteNonQuery();
            }
            catch (Exception)
            {
                return false;
            }

            finally
            {
                connection.Close();
            }

            return (rowsAffected > 0);
        }

        public static bool _DeleteCountry(int ID)
        {
            SqlConnection connection = new SqlConnection(connectionString);
            string query = @"delete from Countries
                        where CountryID = @CountryID";

            SqlCommand command = new SqlCommand(query, connection);

            command.Parameters.AddWithValue("@CountryID", ID);

            int RowsAffected = 0;

            try
            {
                connection.Open(); // never forget to open the connection, then close it at the end
                RowsAffected = command.ExecuteNonQuery();
            }

            catch (Exception)
            {
                return false;
            }

            finally
            {
                connection.Close();
            }

            return (RowsAffected > 0);
        }

        public static DataTable GetAllCountries()
        {
            SqlConnection connection = new SqlConnection(connectionString);
            string query = "select * from Countries";

            SqlCommand command = new SqlCommand(query, connection);

            DataTable dt = new DataTable();

            try
            {
                connection.Open(); // never forget to open the connection, then close it at the end
                SqlDataReader reader = command.ExecuteReader();

                while (reader.HasRows)
                {
                    dt.Load(reader);
                }
            }

            catch (Exception)
            {

            }

            finally
            {
                connection.Close();
            }

            return dt;
        }

        public static bool DoesCountryExist(int ID)
        {
            SqlConnection connection = new SqlConnection(connectionString);
            string query = "select found = 1 from Countries where CountryID = @CountryID";

            SqlCommand command = new SqlCommand(query, connection);
            command.Parameters.AddWithValue("@CountryID", ID);

            try
            {
                connection.Open(); // never forget to open the connection, then close it at the end

                object reader = command.ExecuteScalar();

                if (reader != null)
                {
                    return true;
                }
            }

            catch (Exception)
            {
                return false;
            }

            finally
            {
                connection.Close();
            }

            return false;
        }

        public static bool DoesCountryExist(string CountryName)
        {
            SqlConnection connection = new SqlConnection(connectionString);
            string query = "select found = 1 from Countries where CountryName = @CountryName";

            SqlCommand command = new SqlCommand(query, connection);
            command.Parameters.AddWithValue("@CountryName", CountryName);

            try
            {
                connection.Open(); // never forget to open the connection, then close it at the end

                object reader = command.ExecuteScalar();

                if (reader != null)
                {
                    return true;
                }
            }

            catch (Exception)
            {
                return false;
            }

            finally
            {
                connection.Close();
            }

            return false;
        }
    }
}
